<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Tetris</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>

<script src="paperjs/dist/paper-full.js"></script>
<script type="text/javascript">

 function loadJSON(callback) {   

    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', '/config', false); 
    xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == "200") {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
          }
    };  
    xobj.send(null);

 }

function loadConfig() {
 loadJSON(function(response) {
  // Parse JSON string into object
    myConfig = JSON.parse(response);
    console.log("myConfig is loaded");
 });
}
var myConfig = {} ;
//myConfig will be global 
loadConfig();
console.log("piece.name="+myConfig.piece.name);
</script>
</head>
<body>

<canvas id="myCanvas" resize></canvas>

<script type="text/paperscript" canvas="myCanvas">
var piece=drawPiece(40,40,myConfig.piece);

var angle=1;
setInterval(r,10);
function r(){piece.rotate(angle);}

function drawBlock(x,y){

	var colorMain="#FF0000";
	var colorLight="#FFAA00";
	var colorDark="#CC0000";
	var sizeLight = myConfig.sizeBlock/10; 	
	
	var point = new Point(x, y);
	var size = new Size(myConfig.sizeBlock, myConfig.sizeBlock);
	var path = new Path.Rectangle(point, size);
	path.fillColor = colorMain; 

	var point = new Point(x, y);
	var size = new Size(sizeLight, myConfig.sizeBlock);
	var path2 = new Path.Rectangle(point, size);
	path2.fillColor = colorLight;

	var point = new Point(x+myConfig.sizeBlock-sizeLight, y);
	var size = new Size(sizeLight,myConfig.sizeBlock);
	var path4 = new Path.Rectangle(point, size);
	path4.fillColor = colorDark;

	var point = new Point(x, y);
	var size = new Size(myConfig.sizeBlock,sizeLight);
	var path3 = new Path.Rectangle(point, size);
	path3.fillColor = colorLight;

	var point = new Point(x, y+myConfig.sizeBlock-sizeLight);
	var size = new Size(myConfig.sizeBlock,sizeLight);
	var path5 = new Path.Rectangle(point, size);
	path5.fillColor = colorDark;

	var block = new Group({
	    children: [path, path2, path3, path4, path5] 
	});
	return block;
}


function drawPiece(x,y,pieceData ){
    var blocPresence=0;
    var arrayOfBlock = [];
    for(i=0;i<pieceData.height;i++){
        for(j=0;j<pieceData.width;j++){
            blocPresence=pieceData.data[i][j];
            console.log("blocPresence["+i+"]["+j+"]="+blocPresence);
            if(blocPresence==true){
                var block=drawBlock(x,y);
                arrayOfBlock.push(block);
            }
            x=+myConfig.sizeBlock;
        }
        y+=myConfig.sizeBlock;
	var piece=new Group({
		children:arrayOfBlock
	});
	return piece;
    }
}


</script>
</body>
</html>
